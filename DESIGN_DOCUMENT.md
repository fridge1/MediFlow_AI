# ç±»ä¼¼ Dify çš„åº”ç”¨ç®¡ç†å’Œä¼šè¯ç®¡ç†ç³»ç»Ÿ - æŠ€æœ¯æ–¹æ¡ˆ

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ—¨åœ¨æ„å»ºä¸€ä¸ªç±»ä¼¼ Dify çš„ AI åº”ç”¨ç®¡ç†å’Œä¼šè¯ç®¡ç†å¹³å°ï¼Œæ”¯æŒå¤šåº”ç”¨ç®¡ç†ã€å¤šè½®å¯¹è¯ã€æç¤ºè¯æ¨¡æ¿ã€æ¨¡å‹é…ç½®ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### ğŸ”‘ æ ¸å¿ƒè®¾è®¡ç†å¿µ

**ç‹¬ç«‹ä¼šè¯æ¶æ„**: æœ¬ç³»ç»Ÿé‡‡ç”¨è§£è€¦è®¾è®¡ï¼Œä¼šè¯ç®¡ç†å®Œå…¨ç‹¬ç«‹ï¼Œä¸å¼ºåˆ¶ç»‘å®šåº”ç”¨æˆ–æ¨¡å‹é…ç½®ã€‚

- âœ… **ä¼šè¯ç‹¬ç«‹**: ä¼šè¯æ˜¯é€šç”¨çš„å¯¹è¯å®¹å™¨ï¼Œå¯åœ¨ä»»ä½•åœºæ™¯ä½¿ç”¨
- âœ… **çµæ´»é…ç½®**: æ¯æ¬¡å¯¹è¯å¯åŠ¨æ€é€‰æ‹©æ¨¡å‹å’Œå‚æ•°
- âœ… **å¯é€‰æ¨¡æ¿**: åº”ç”¨ä½œä¸ºé…ç½®æ¨¡æ¿å­˜åœ¨ï¼Œæä¾›ä¾¿æ·æ€§ä½†ä¸å¼ºåˆ¶ä½¿ç”¨
- âœ… **ä¸‰çº§é…ç½®**: è¯·æ±‚çº§ > åº”ç”¨çº§ï¼ˆå¯é€‰ï¼‰> ç”¨æˆ·é»˜è®¤çº§

è¿™ç§è®¾è®¡ä½¿ç³»ç»Ÿæ›´åŠ çµæ´»ï¼Œæ˜“äºé›†æˆåˆ°å„ç§ä¸šåŠ¡åœºæ™¯ä¸­ã€‚

### 1.1 æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

1. **ç”¨æˆ·ç®¡ç†æ¨¡å—**
   - ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€è®¤è¯
   - JWT Token è®¤è¯æœºåˆ¶
   - ç”¨æˆ·æƒé™ç®¡ç†

2. **åº”ç”¨ç®¡ç†æ¨¡å—**
   - åº”ç”¨åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤
   - åº”ç”¨é…ç½®ï¼ˆæ¨¡å‹é€‰æ‹©ã€å‚æ•°è®¾ç½®ï¼‰
   - æç¤ºè¯æ¨¡æ¿ç®¡ç†
   - åº”ç”¨å‘å¸ƒ/è‰ç¨¿çŠ¶æ€ç®¡ç†
   - **æ³¨æ„**: åº”ç”¨æ˜¯å¯é€‰çš„é…ç½®æ¨¡æ¿ï¼Œä¸å¼ºåˆ¶ä¸ä¼šè¯ç»‘å®š

3. **ä¼šè¯ç®¡ç†æ¨¡å—ï¼ˆç‹¬ç«‹ï¼‰**
   - é€šç”¨çš„å¤šè½®å¯¹è¯ç®¡ç†ï¼Œä¸ä¾èµ–åº”ç”¨
   - ä¼šè¯å†å²è®°å½•
   - ä¸Šä¸‹æ–‡ç»´æŠ¤
   - ä¼šè¯åˆ—è¡¨æŸ¥è¯¢
   - æ”¯æŒçµæ´»æŒ‡å®šæ¨¡å‹å’Œå‚æ•°

4. **æ¶ˆæ¯ç®¡ç†æ¨¡å—**
   - æ¶ˆæ¯å‘é€ä¸æ¥æ”¶
   - æµå¼å“åº”æ”¯æŒï¼ˆSSEï¼‰
   - æ¶ˆæ¯å†å²æŸ¥è¯¢
   - æ¶ˆæ¯è¯„ä»·åé¦ˆ

5. **æ¨¡å‹ç®¡ç†æ¨¡å—**
   - å¤šæ¨¡å‹æ”¯æŒï¼ˆOpenAIã€Claudeã€æœ¬åœ°æ¨¡å‹ç­‰ï¼‰
   - æ¨¡å‹å‚æ•°é…ç½®
   - API Key ç®¡ç†

6. **çŸ¥è¯†åº“æ¨¡å—ï¼ˆå¯é€‰æ‰©å±•ï¼‰**
   - æ–‡æ¡£ä¸Šä¼ ä¸ç®¡ç†
   - å‘é‡åŒ–å­˜å‚¨
   - RAG æ£€ç´¢å¢å¼º

## äºŒã€æŠ€æœ¯æ¶æ„

### 2.1 æŠ€æœ¯æ ˆ

#### åç«¯æŠ€æœ¯
- **Web æ¡†æ¶**: FastAPI 0.104+
- **æ•°æ®åº“**: PostgreSQL 15+ (ä¸»æ•°æ®åº“)
- **ç¼“å­˜**: Redis 7+ (ä¼šè¯ç¼“å­˜ã€Token ç¼“å­˜)
- **å‘é‡æ•°æ®åº“**: Milvus (çŸ¥è¯†åº“åŠŸèƒ½)
- **ORM**: SQLAlchemy 2.0+ with Alembic (æ•°æ®åº“è¿ç§»)
- **è®¤è¯**: python-jose (JWT), passlib (å¯†ç åŠ å¯†)
- **å¼‚æ­¥ä»»åŠ¡**: Celery + Redis
- **AI SDK**: 
  - OpenAI SDK (OpenAI æ¨¡å‹)
  - DashScope SDK (é€šä¹‰åƒé—®)
  - OpenAI-Compatible API (DeepSeekã€ç¡…åŸºæµåŠ¨)
  - ç»Ÿä¸€é€‚é…å±‚å°è£…

#### å¼€å‘å·¥å…·
- **API æ–‡æ¡£**: Swagger/OpenAPI (FastAPI è‡ªåŠ¨ç”Ÿæˆ)
- **ä»£ç è´¨é‡**: Black, Flake8, Pylint
- **æµ‹è¯•**: Pytest, pytest-asyncio
- **å®¹å™¨åŒ–**: Docker, Docker Compose

### 2.2 é¡¹ç›®ç»“æ„

```
medical_project/
â”œâ”€â”€ alembic/                    # æ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ versions/
â”‚   â””â”€â”€ env.py
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py          # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ security.py        # å®‰å…¨ç›¸å…³ï¼ˆJWTã€å¯†ç ï¼‰
â”‚   â”‚   â”œâ”€â”€ database.py        # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ redis_client.py    # Redis è¿æ¥
â”‚   â”‚   â””â”€â”€ milvus_client.py   # Milvus è¿æ¥
â”‚   â”œâ”€â”€ models/                 # SQLAlchemy æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ application.py
â”‚   â”‚   â”œâ”€â”€ conversation.py
â”‚   â”‚   â”œâ”€â”€ message.py
â”‚   â”‚   â””â”€â”€ model_config.py
â”‚   â”œâ”€â”€ schemas/                # Pydantic æ¨¡å‹ï¼ˆè¯·æ±‚/å“åº”ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ application.py
â”‚   â”‚   â”œâ”€â”€ conversation.py
â”‚   â”‚   â”œâ”€â”€ message.py
â”‚   â”‚   â””â”€â”€ common.py
â”‚   â”œâ”€â”€ api/                    # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ deps.py            # ä¾èµ–é¡¹ï¼ˆè®¤è¯ã€æ•°æ®åº“ä¼šè¯ï¼‰
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ auth.py
â”‚   â”‚       â”œâ”€â”€ users.py
â”‚   â”‚       â”œâ”€â”€ applications.py
â”‚   â”‚       â”œâ”€â”€ conversations.py
â”‚   â”‚       â”œâ”€â”€ messages.py
â”‚   â”‚       â””â”€â”€ models.py
â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_service.py
â”‚   â”‚   â”œâ”€â”€ app_service.py
â”‚   â”‚   â”œâ”€â”€ conversation_service.py
â”‚   â”‚   â”œâ”€â”€ message_service.py
â”‚   â”‚   â”œâ”€â”€ ai_service.py      # AI æ¨¡å‹è°ƒç”¨ï¼ˆå¤šå¹³å°é€‚é…ï¼‰
â”‚   â”‚   â”œâ”€â”€ embedding_service.py  # Embedding æœåŠ¡
â”‚   â”‚   â””â”€â”€ vector_service.py  # å‘é‡å­˜å‚¨ä¸æ£€ç´¢ï¼ˆMilvusï¼‰
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ logger.py
â”‚   â”‚   â””â”€â”€ exceptions.py
â”‚   â””â”€â”€ middleware/             # ä¸­é—´ä»¶
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ error_handler.py
â”œâ”€â”€ tests/                      # æµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py
â”‚   â”œâ”€â”€ test_auth.py
â”‚   â”œâ”€â”€ test_applications.py
â”‚   â””â”€â”€ test_conversations.py
â”œâ”€â”€ scripts/                    # è„šæœ¬
â”‚   â””â”€â”€ init_db.py
â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .gitignore
â”œâ”€â”€ requirements.txt            # ä¾èµ–åŒ…
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ alembic.ini                 # Alembic é…ç½®
â””â”€â”€ README.md
```

## ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„

#### users (ç”¨æˆ·è¡¨)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    full_name VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    is_superuser BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### applications (åº”ç”¨è¡¨)
```sql
CREATE TABLE applications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    icon VARCHAR(255),
    status VARCHAR(50) DEFAULT 'draft',  -- draft, published
    app_type VARCHAR(50) DEFAULT 'chatbot',  -- chatbot, completion, agent
    
    -- æ¨¡å‹é…ç½®
    model_provider VARCHAR(50) DEFAULT 'openai',  -- openai, qwen, deepseek, siliconflow
    model_name VARCHAR(100) DEFAULT 'gpt-3.5-turbo',
    model_config JSONB DEFAULT '{}',  -- temperature, max_tokens, etc.
    
    -- æç¤ºè¯é…ç½®
    system_prompt TEXT,
    user_prompt_template TEXT,
    opening_statement TEXT,  -- å¼€åœºç™½
    
    -- å…¶ä»–é…ç½®
    max_conversation_length INTEGER DEFAULT 10,
    enable_context BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
);
```

#### conversations (ä¼šè¯è¡¨)
```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255),
    status VARCHAR(50) DEFAULT 'active',  -- active, archived, deleted
    summary TEXT,
    
    -- ä¼šè¯å…ƒæ•°æ®ï¼ˆå¯å­˜å‚¨å…³è”çš„åº”ç”¨IDç­‰æ‰©å±•ä¿¡æ¯ï¼‰
    metadata JSONB DEFAULT '{}',
    message_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    last_message_at TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_last_message (last_message_at DESC)
);
```

**è¯´æ˜**: 
- ç§»é™¤äº† `application_id` å¤–é”®çº¦æŸï¼Œä¼šè¯ä¸å†å¼ºåˆ¶å…³è”åº”ç”¨
- ä¼šè¯æ˜¯ç‹¬ç«‹çš„å¯¹è¯å®¹å™¨ï¼Œå¯ä»¥åœ¨ä»»ä½•åœºæ™¯ä½¿ç”¨
- å¦‚éœ€å…³è”åº”ç”¨ï¼Œå¯é€šè¿‡ `metadata` å­—æ®µçµæ´»å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
- è¿™æ ·è®¾è®¡ä½¿ä¼šè¯ç®¡ç†æ›´åŠ é€šç”¨å’Œçµæ´»

#### messages (æ¶ˆæ¯è¡¨)
```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    
    -- æ¶ˆæ¯å†…å®¹
    role VARCHAR(50) NOT NULL,  -- user, assistant, system
    content TEXT NOT NULL,
    
    -- æ¨¡å‹ä¿¡æ¯ï¼ˆæ¯æ¡æ¶ˆæ¯å¯ä½¿ç”¨ä¸åŒæ¨¡å‹ï¼‰
    model_provider VARCHAR(50),  -- openai, qwen, deepseek, siliconflow
    model_name VARCHAR(100),     -- gpt-4, qwen-max, deepseek-chat, etc.
    model_config JSONB DEFAULT '{}',  -- æœ¬æ¬¡ä½¿ç”¨çš„æ¨¡å‹å‚æ•°
    
    -- Token ç»Ÿè®¡
    token_count INTEGER DEFAULT 0,
    prompt_tokens INTEGER DEFAULT 0,
    completion_tokens INTEGER DEFAULT 0,
    
    -- åé¦ˆ
    feedback VARCHAR(50),  -- like, dislike, null
    feedback_comment TEXT,
    
    -- æ—¶é—´
    created_at TIMESTAMP DEFAULT NOW(),
    
    INDEX idx_conversation_id (conversation_id),
    INDEX idx_created_at (created_at DESC),
    INDEX idx_role (role)
);
```

**è¯´æ˜**:
- æ¯æ¡æ¶ˆæ¯è®°å½•ä½¿ç”¨çš„æ¨¡å‹ä¿¡æ¯ï¼Œæ”¯æŒåŒä¸€ä¼šè¯ä½¿ç”¨ä¸åŒæ¨¡å‹
- `model_config` å­˜å‚¨æœ¬æ¬¡æ¶ˆæ¯ä½¿ç”¨çš„å…·ä½“å‚æ•°ï¼ˆtemperatureã€max_tokens ç­‰ï¼‰
- ä¾¿äºåç»­åˆ†æä¸åŒæ¨¡å‹çš„æ•ˆæœå’Œæˆæœ¬

#### model_configs (æ¨¡å‹é…ç½®è¡¨)
```sql
CREATE TABLE model_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    provider VARCHAR(50) NOT NULL,  -- openai, qwen, deepseek, siliconflow
    model_name VARCHAR(100) NOT NULL,
    api_key VARCHAR(255) NOT NULL,  -- åŠ å¯†å­˜å‚¨
    api_base VARCHAR(255),
    is_default BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    config JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(user_id, provider, model_name),
    INDEX idx_user_id (user_id),
    INDEX idx_provider (provider)
);
```

**æ”¯æŒçš„æ¨¡å‹æä¾›å•†**:
- `openai`: OpenAI å®˜æ–¹ï¼ˆgpt-4, gpt-3.5-turbo ç­‰ï¼‰
- `qwen`: é˜¿é‡Œäº‘é€šä¹‰åƒé—®ï¼ˆqwen-turbo, qwen-plus, qwen-max ç­‰ï¼‰
- `deepseek`: DeepSeekï¼ˆdeepseek-chat, deepseek-coder ç­‰ï¼‰
- `siliconflow`: ç¡…åŸºæµåŠ¨ï¼ˆæ”¯æŒå¤šç§å¼€æºæ¨¡å‹ï¼‰

### 3.2 Redis ç¼“å­˜è®¾è®¡

```python
# ä¼šè¯ç¼“å­˜ï¼ˆä¿å­˜æœ€è¿‘çš„æ¶ˆæ¯ä¸Šä¸‹æ–‡ï¼‰
conversation:{conversation_id}:messages  # List, ä¿å­˜æœ€è¿‘ N æ¡æ¶ˆæ¯
conversation:{conversation_id}:context   # String, JSON æ ¼å¼çš„ä¸Šä¸‹æ–‡
conversation:{conversation_id}:model     # Hash, å½“å‰ä¼šè¯æœ€è¿‘ä½¿ç”¨çš„æ¨¡å‹ä¿¡æ¯

# Token ç¼“å­˜
user:{user_id}:token                     # String, JWT Token
token_blacklist:{token_jti}              # String, å·²åºŸå¼ƒçš„ Token

# ç”¨æˆ·é…ç½®ç¼“å­˜
user:{user_id}:default_model             # Hash, ç”¨æˆ·é»˜è®¤æ¨¡å‹é…ç½®
application:{app_id}:config              # Hash, åº”ç”¨é…ç½®ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

# é™æµ
rate_limit:{user_id}:{endpoint}          # String, è¯·æ±‚è®¡æ•°

# ä¼šè¯é”ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
conversation:{conversation_id}:lock      # String, åˆ†å¸ƒå¼é”
```

## å››ã€API è®¾è®¡

### 4.1 è®¤è¯ç›¸å…³ API

```
POST   /api/v1/auth/register          # ç”¨æˆ·æ³¨å†Œ
POST   /api/v1/auth/login             # ç”¨æˆ·ç™»å½•
POST   /api/v1/auth/refresh           # åˆ·æ–° Token
POST   /api/v1/auth/logout            # é€€å‡ºç™»å½•
GET    /api/v1/auth/me                # è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
```

### 4.2 åº”ç”¨ç®¡ç† APIï¼ˆå¯é€‰é…ç½®æ¨¡æ¿ï¼‰

```
POST   /api/v1/applications                  # åˆ›å»ºåº”ç”¨é…ç½®æ¨¡æ¿
GET    /api/v1/applications                  # è·å–åº”ç”¨åˆ—è¡¨
GET    /api/v1/applications/{id}             # è·å–åº”ç”¨è¯¦æƒ…
GET    /api/v1/applications/{id}/config      # è·å–åº”ç”¨çš„æ¨¡å‹é…ç½®
PUT    /api/v1/applications/{id}             # æ›´æ–°åº”ç”¨
DELETE /api/v1/applications/{id}             # åˆ é™¤åº”ç”¨
POST   /api/v1/applications/{id}/publish     # å‘å¸ƒåº”ç”¨
```

**è¯´æ˜**:
- åº”ç”¨æ˜¯å¯å¤ç”¨çš„é…ç½®æ¨¡æ¿ï¼ˆæç¤ºè¯ã€æ¨¡å‹å‚æ•°ç­‰ï¼‰
- ä¸å¼ºåˆ¶è¦æ±‚åˆ›å»ºåº”ç”¨ï¼Œä¼šè¯å¯ç‹¬ç«‹ä½¿ç”¨
- åº”ç”¨é…ç½®å¯åœ¨æ¶ˆæ¯å‘é€æ—¶ä½œä¸ºæ¨¡æ¿å¼•ç”¨

### 4.3 ä¼šè¯ç®¡ç† API

```
POST   /api/v1/conversations                      # åˆ›å»ºä¼šè¯ï¼ˆç‹¬ç«‹ï¼Œæ— éœ€å…³è”åº”ç”¨ï¼‰
GET    /api/v1/conversations                      # è·å–ä¼šè¯åˆ—è¡¨
GET    /api/v1/conversations/{id}                 # è·å–ä¼šè¯è¯¦æƒ…
PUT    /api/v1/conversations/{id}                 # æ›´æ–°ä¼šè¯ï¼ˆæ ‡é¢˜ã€çŠ¶æ€ç­‰ï¼‰
DELETE /api/v1/conversations/{id}                 # åˆ é™¤ä¼šè¯
GET    /api/v1/conversations/{id}/messages        # è·å–ä¼šè¯æ¶ˆæ¯åˆ—è¡¨
POST   /api/v1/conversations/{id}/messages        # å‘é€æ¶ˆæ¯åˆ°ä¼šè¯
POST   /api/v1/conversations/{id}/messages/stream # å‘é€æ¶ˆæ¯ï¼ˆæµå¼å“åº”ï¼‰
```

**è¯´æ˜**:
- ä¼šè¯åˆ›å»ºæ—¶åªéœ€æä¾›åŸºæœ¬ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€å…ƒæ•°æ®ç­‰ï¼‰ï¼Œä¸éœ€è¦å…³è”åº”ç”¨
- æ¶ˆæ¯å‘é€æ—¶å¯åœ¨è¯·æ±‚ä½“ä¸­æŒ‡å®šä½¿ç”¨çš„æ¨¡å‹å’Œå‚æ•°ï¼ˆä¸´æ—¶é…ç½®ï¼‰
- ä¹Ÿå¯ä»¥ä½¿ç”¨ç”¨æˆ·é»˜è®¤çš„æ¨¡å‹é…ç½®
- ä¼šè¯ç®¡ç†å®Œå…¨ç‹¬ç«‹ï¼Œå¯çµæ´»åº”ç”¨äºå„ç§åœºæ™¯

### 4.4 æ¶ˆæ¯ç®¡ç† API

```
GET    /api/v1/messages/{id}                      # è·å–å•æ¡æ¶ˆæ¯è¯¦æƒ…
PUT    /api/v1/messages/{id}/feedback             # æ¶ˆæ¯åé¦ˆï¼ˆç‚¹èµ/ç‚¹è¸©ï¼‰
DELETE /api/v1/messages/{id}                      # åˆ é™¤æ¶ˆæ¯
```

**æ¶ˆæ¯å‘é€è¯·æ±‚ç¤ºä¾‹**:
```json
POST /api/v1/conversations/{id}/messages
{
  "content": "ç”¨æˆ·æ¶ˆæ¯å†…å®¹",
  "model_provider": "openai",          // å¯é€‰ï¼ŒæŒ‡å®šæ¨¡å‹æä¾›å•†
  "model_name": "gpt-4",               // å¯é€‰ï¼ŒæŒ‡å®šæ¨¡å‹
  "model_config": {                     // å¯é€‰ï¼Œä¸´æ—¶æ¨¡å‹å‚æ•°
    "temperature": 0.7,
    "max_tokens": 2000,
    "system_prompt": "ä½ æ˜¯ä¸€ä¸ªåŒ»ç–—åŠ©æ‰‹..."
  }
}
```

**è¯´æ˜**:
- å¦‚ä¸æŒ‡å®šæ¨¡å‹å‚æ•°ï¼Œä½¿ç”¨ç”¨æˆ·çš„é»˜è®¤æ¨¡å‹é…ç½®
- æ”¯æŒæ¯æ¬¡å¯¹è¯ä¸´æ—¶æŒ‡å®šä¸åŒçš„æ¨¡å‹å’Œå‚æ•°
- ä¼šè¯ä¸ç»‘å®šç‰¹å®šæ¨¡å‹ï¼Œçµæ´»æ€§æ›´é«˜

### 4.5 æ¨¡å‹é…ç½® API

```
POST   /api/v1/models                 # æ·»åŠ æ¨¡å‹é…ç½®
GET    /api/v1/models                 # è·å–æ¨¡å‹é…ç½®åˆ—è¡¨
PUT    /api/v1/models/{id}            # æ›´æ–°æ¨¡å‹é…ç½®
DELETE /api/v1/models/{id}            # åˆ é™¤æ¨¡å‹é…ç½®
```

## äº”ã€åº”ç”¨ä¸ä¼šè¯çš„å…³ç³»è®¾è®¡

### 5.1 ç‹¬ç«‹ä¼šè¯æ¶æ„

æœ¬ç³»ç»Ÿé‡‡ç”¨**è§£è€¦è®¾è®¡**ï¼Œä¼šè¯ç®¡ç†å®Œå…¨ç‹¬ç«‹ï¼Œä¸å¼ºåˆ¶ä¾èµ–åº”ç”¨ï¼š

1. **ç‹¬ç«‹ä¼šè¯æ¨¡å¼**ï¼ˆæ¨èï¼‰
   - ä¼šè¯åˆ›å»ºæ—¶æ— éœ€å…³è”åº”ç”¨
   - æ¯æ¬¡å‘é€æ¶ˆæ¯æ—¶å¯çµæ´»æŒ‡å®šæ¨¡å‹å‚æ•°
   - é€‚ç”¨äºè‡ªç”±å¯¹è¯ã€ä¸´æ—¶å’¨è¯¢ç­‰åœºæ™¯

2. **åº”ç”¨æ¨¡æ¿æ¨¡å¼**ï¼ˆå¯é€‰ï¼‰
   - åº”ç”¨ä½œä¸ºå¯å¤ç”¨çš„é…ç½®æ¨¡æ¿å­˜åœ¨
   - ç”¨æˆ·å¯åˆ›å»º"åŒ»ç–—é—®è¯ŠåŠ©æ‰‹"ã€"å¥åº·å’¨è¯¢"ç­‰åº”ç”¨æ¨¡æ¿
   - å‘é€æ¶ˆæ¯æ—¶å¯å¼•ç”¨åº”ç”¨é…ç½®ï¼ˆé€šè¿‡ metadata æˆ–è¯·æ±‚å‚æ•°ï¼‰
   - å®¢æˆ·ç«¯å±‚é¢å®ç°åº”ç”¨ä¸ä¼šè¯çš„å…³è”

3. **çµæ´»ç»„åˆ**
   ```json
   // åœºæ™¯1: å®Œå…¨ç‹¬ç«‹çš„ä¼šè¯
   POST /api/v1/conversations
   {
     "title": "ä»Šæ—¥å’¨è¯¢",
     "metadata": {}
   }
   
   // åœºæ™¯2: ä¼šè¯å¯é€‰å…³è”åº”ç”¨é…ç½®ï¼ˆå®¢æˆ·ç«¯é€»è¾‘ï¼‰
   POST /api/v1/conversations
   {
     "title": "åŒ»ç–—é—®è¯Š",
     "metadata": {
       "application_id": "xxx",  // å¯é€‰ï¼Œå®¢æˆ·ç«¯è®°å½•
       "source": "medical_app"
     }
   }
   
   // å‘é€æ¶ˆæ¯æ—¶å¼•ç”¨åº”ç”¨é…ç½®
   POST /api/v1/conversations/{id}/messages
   {
     "content": "æˆ‘å¤´ç–¼",
     "use_application_config": "application_id_xxx"  // å¯é€‰
   }
   ```

### 5.2 è®¾è®¡ä¼˜åŠ¿

- âœ… **é«˜åº¦è§£è€¦**: ä¼šè¯ä¸ä¾èµ–åº”ç”¨ï¼Œå¯ä»¥åœ¨ä»»ä½•åœºæ™¯ä½¿ç”¨
- âœ… **çµæ´»é…ç½®**: æ”¯æŒæ¯æ¬¡å¯¹è¯ä½¿ç”¨ä¸åŒçš„æ¨¡å‹å‚æ•°
- âœ… **å¯é€‰æ¨¡æ¿**: åº”ç”¨ä½œä¸ºé…ç½®æ¨¡æ¿ï¼Œæä¾›ä¾¿æ·æ€§ä½†ä¸å¼ºåˆ¶
- âœ… **æ˜“äºæ‰©å±•**: æœªæ¥å¯è½»æ¾é›†æˆåˆ°å…¶ä»–ç³»ç»Ÿä¸­

### 5.3 å…¸å‹ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

#### åœºæ™¯1: å®Œå…¨ç‹¬ç«‹çš„ä¸´æ—¶ä¼šè¯
```bash
# 1. åˆ›å»ºä¼šè¯ï¼ˆæ— éœ€å…³è”ä»»ä½•åº”ç”¨ï¼‰
POST /api/v1/conversations
{
  "title": "ä¸´æ—¶å’¨è¯¢"
}
# è¿”å›: { "id": "conv_123", ... }

# 2. å‘é€æ¶ˆæ¯ï¼ˆç›´æ¥æŒ‡å®šæ¨¡å‹ï¼‰
POST /api/v1/conversations/conv_123/messages
{
  "content": "è¯·å¸®æˆ‘åˆ†æä¸€ä¸‹è¿™ä¸ªç—‡çŠ¶",
  "model_provider": "openai",
  "model_name": "gpt-4",
  "model_config": {
    "temperature": 0.7,
    "max_tokens": 2000
  }
}
```

#### åœºæ™¯2: ä½¿ç”¨ç”¨æˆ·é»˜è®¤é…ç½®
```bash
# 1. ç”¨æˆ·é¢„å…ˆè®¾ç½®é»˜è®¤æ¨¡å‹
POST /api/v1/models
{
  "provider": "openai",
  "model_name": "gpt-3.5-turbo",
  "api_key": "sk-xxx",
  "is_default": true,
  "config": {
    "temperature": 0.8
  }
}

# 2. åˆ›å»ºä¼šè¯å¹¶å‘é€æ¶ˆæ¯ï¼ˆä¸æŒ‡å®šæ¨¡å‹ï¼Œè‡ªåŠ¨ä½¿ç”¨é»˜è®¤ï¼‰
POST /api/v1/conversations
{ "title": "æ—¥å¸¸å’¨è¯¢" }

POST /api/v1/conversations/conv_456/messages
{
  "content": "ä½ å¥½"
  // è‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·çš„é»˜è®¤æ¨¡å‹é…ç½®
}
```

#### åœºæ™¯3: å¼•ç”¨åº”ç”¨æ¨¡æ¿é…ç½®ï¼ˆå¯é€‰ï¼‰
```bash
# 1. åˆ›å»ºåº”ç”¨æ¨¡æ¿ï¼ˆå¯å¤ç”¨çš„é…ç½®ï¼‰
POST /api/v1/applications
{
  "name": "åŒ»ç–—é—®è¯ŠåŠ©æ‰‹",
  "model_provider": "openai",
  "model_name": "gpt-4",
  "model_config": {
    "temperature": 0.3,
    "max_tokens": 3000
  },
  "system_prompt": "ä½ æ˜¯ä¸€åä¸“ä¸šçš„åŒ»ç–—åŠ©æ‰‹ï¼Œè¯·è°¨æ…å›ç­”é—®é¢˜..."
}
# è¿”å›: { "id": "app_789", ... }

# 2. åˆ›å»ºä¼šè¯ï¼ˆå¯é€‰åœ¨ metadata ä¸­è®°å½•ï¼‰
POST /api/v1/conversations
{
  "title": "åŒ»ç–—é—®è¯Š",
  "metadata": {
    "application_id": "app_789",  // å®¢æˆ·ç«¯è®°å½•ï¼Œæ–¹ä¾¿ç®¡ç†
    "scene": "medical"
  }
}

# 3. å‘é€æ¶ˆæ¯æ—¶å¼•ç”¨åº”ç”¨é…ç½®
POST /api/v1/conversations/conv_789/messages
{
  "content": "æˆ‘æœ€è¿‘å¤´ç—›",
  "use_application_config": "app_789"  // å¼•ç”¨åº”ç”¨çš„æ¨¡å‹é…ç½®
}
```

#### åœºæ™¯4: åŒä¸€ä¼šè¯ä½¿ç”¨å¤šä¸ªæ¨¡å‹
```bash
# åˆ›å»ºä¼šè¯
POST /api/v1/conversations
{ "title": "æ¨¡å‹å¯¹æ¯”æµ‹è¯•" }

# ç¬¬ä¸€æ¡æ¶ˆæ¯ä½¿ç”¨ GPT-4
POST /api/v1/conversations/conv_999/messages
{
  "content": "è¯·åˆ†æè¿™ä¸ªé—®é¢˜",
  "model_name": "gpt-4"
}

# ç¬¬äºŒæ¡æ¶ˆæ¯ä½¿ç”¨ Claude
POST /api/v1/conversations/conv_999/messages
{
  "content": "åŒæ ·çš„é—®é¢˜",
  "model_provider": "anthropic",
  "model_name": "claude-3-opus"
}

# æ¯æ¡æ¶ˆæ¯éƒ½ä¼šè®°å½•ä½¿ç”¨çš„æ¨¡å‹ä¿¡æ¯
```

## å…­ã€å¤šå¹³å°æ¨¡å‹é€‚é…æ–¹æ¡ˆ

### 6.1 æ”¯æŒçš„æ¨¡å‹å¹³å°

#### 1. OpenAI
- **API åœ°å€**: `https://api.openai.com/v1`
- **è®¤è¯æ–¹å¼**: Bearer Token (API Key)
- **æ”¯æŒæ¨¡å‹**: gpt-4, gpt-4-turbo, gpt-3.5-turbo ç­‰
- **SDK**: `openai` Python å®˜æ–¹åº“

#### 2. é€šä¹‰åƒé—®ï¼ˆé˜¿é‡Œäº‘ DashScopeï¼‰
- **API åœ°å€**: `https://dashscope.aliyuncs.com/api/v1`
- **è®¤è¯æ–¹å¼**: API Key (X-DashScope-API-Key)
- **æ”¯æŒæ¨¡å‹**: qwen-turbo, qwen-plus, qwen-max, qwen-vl-plus ç­‰
- **SDK**: `dashscope` Python å®˜æ–¹åº“

#### 3. DeepSeek
- **API åœ°å€**: `https://api.deepseek.com/v1`
- **è®¤è¯æ–¹å¼**: Bearer Token (API Key)
- **æ”¯æŒæ¨¡å‹**: deepseek-chat, deepseek-coder ç­‰
- **SDK**: OpenAI-Compatible APIï¼ˆä½¿ç”¨ `openai` åº“ï¼‰

#### 4. ç¡…åŸºæµåŠ¨ï¼ˆSiliconFlowï¼‰
- **API åœ°å€**: `https://api.siliconflow.cn/v1`
- **è®¤è¯æ–¹å¼**: Bearer Token (API Key)
- **æ”¯æŒæ¨¡å‹**: Qwenç³»åˆ—ã€DeepSeekç³»åˆ—ã€ChatGLMç³»åˆ—ç­‰å¼€æºæ¨¡å‹
- **SDK**: OpenAI-Compatible APIï¼ˆä½¿ç”¨ `openai` åº“ï¼‰

### 6.2 ç»Ÿä¸€é€‚é…å±‚è®¾è®¡

```python
# app/services/ai_service.py

from abc import ABC, abstractmethod
from typing import AsyncIterator, Dict, Any
import openai
from dashscope import Generation
import dashscope

class BaseModelProvider(ABC):
    """æ¨¡å‹æä¾›å•†åŸºç±»"""
    
    @abstractmethod
    async def chat_completion(
        self, 
        messages: list, 
        model: str, 
        **kwargs
    ) -> Dict[str, Any]:
        """åŒæ­¥èŠå¤©å®Œæˆ"""
        pass
    
    @abstractmethod
    async def chat_completion_stream(
        self, 
        messages: list, 
        model: str, 
        **kwargs
    ) -> AsyncIterator[str]:
        """æµå¼èŠå¤©å®Œæˆ"""
        pass


class OpenAIProvider(BaseModelProvider):
    """OpenAI æ¨¡å‹æä¾›å•†"""
    
    def __init__(self, api_key: str, api_base: str = None):
        self.client = openai.AsyncOpenAI(
            api_key=api_key,
            base_url=api_base or "https://api.openai.com/v1"
        )
    
    async def chat_completion(self, messages: list, model: str, **kwargs):
        response = await self.client.chat.completions.create(
            model=model,
            messages=messages,
            **kwargs
        )
        return {
            "content": response.choices[0].message.content,
            "model": response.model,
            "usage": {
                "prompt_tokens": response.usage.prompt_tokens,
                "completion_tokens": response.usage.completion_tokens,
                "total_tokens": response.usage.total_tokens
            }
        }
    
    async def chat_completion_stream(self, messages: list, model: str, **kwargs):
        stream = await self.client.chat.completions.create(
            model=model,
            messages=messages,
            stream=True,
            **kwargs
        )
        async for chunk in stream:
            if chunk.choices[0].delta.content:
                yield chunk.choices[0].delta.content


class QwenProvider(BaseModelProvider):
    """é€šä¹‰åƒé—®æ¨¡å‹æä¾›å•†"""
    
    def __init__(self, api_key: str):
        dashscope.api_key = api_key
    
    async def chat_completion(self, messages: list, model: str, **kwargs):
        response = Generation.call(
            model=model,
            messages=messages,
            result_format='message',
            **kwargs
        )
        return {
            "content": response.output.choices[0].message.content,
            "model": model,
            "usage": {
                "prompt_tokens": response.usage.input_tokens,
                "completion_tokens": response.usage.output_tokens,
                "total_tokens": response.usage.total_tokens
            }
        }
    
    async def chat_completion_stream(self, messages: list, model: str, **kwargs):
        responses = Generation.call(
            model=model,
            messages=messages,
            result_format='message',
            stream=True,
            **kwargs
        )
        for response in responses:
            if response.output.choices[0].message.content:
                yield response.output.choices[0].message.content


class DeepSeekProvider(BaseModelProvider):
    """DeepSeek æ¨¡å‹æä¾›å•†ï¼ˆOpenAI å…¼å®¹ï¼‰"""
    
    def __init__(self, api_key: str):
        self.client = openai.AsyncOpenAI(
            api_key=api_key,
            base_url="https://api.deepseek.com/v1"
        )
    
    async def chat_completion(self, messages: list, model: str, **kwargs):
        # ä¸ OpenAI å®ç°ç›¸åŒ
        response = await self.client.chat.completions.create(
            model=model,
            messages=messages,
            **kwargs
        )
        return {
            "content": response.choices[0].message.content,
            "model": response.model,
            "usage": {
                "prompt_tokens": response.usage.prompt_tokens,
                "completion_tokens": response.usage.completion_tokens,
                "total_tokens": response.usage.total_tokens
            }
        }
    
    async def chat_completion_stream(self, messages: list, model: str, **kwargs):
        stream = await self.client.chat.completions.create(
            model=model,
            messages=messages,
            stream=True,
            **kwargs
        )
        async for chunk in stream:
            if chunk.choices[0].delta.content:
                yield chunk.choices[0].delta.content


class SiliconFlowProvider(BaseModelProvider):
    """ç¡…åŸºæµåŠ¨æ¨¡å‹æä¾›å•†ï¼ˆOpenAI å…¼å®¹ï¼‰"""
    
    def __init__(self, api_key: str):
        self.client = openai.AsyncOpenAI(
            api_key=api_key,
            base_url="https://api.siliconflow.cn/v1"
        )
    
    async def chat_completion(self, messages: list, model: str, **kwargs):
        response = await self.client.chat.completions.create(
            model=model,
            messages=messages,
            **kwargs
        )
        return {
            "content": response.choices[0].message.content,
            "model": response.model,
            "usage": {
                "prompt_tokens": response.usage.prompt_tokens,
                "completion_tokens": response.usage.completion_tokens,
                "total_tokens": response.usage.total_tokens
            }
        }
    
    async def chat_completion_stream(self, messages: list, model: str, **kwargs):
        stream = await self.client.chat.completions.create(
            model=model,
            messages=messages,
            stream=True,
            **kwargs
        )
        async for chunk in stream:
            if chunk.choices[0].delta.content:
                yield chunk.choices[0].delta.content


class AIModelService:
    """AI æ¨¡å‹æœåŠ¡ç»Ÿä¸€å…¥å£"""
    
    PROVIDERS = {
        "openai": OpenAIProvider,
        "qwen": QwenProvider,
        "deepseek": DeepSeekProvider,
        "siliconflow": SiliconFlowProvider,
    }
    
    @classmethod
    def get_provider(cls, provider: str, api_key: str, api_base: str = None) -> BaseModelProvider:
        """è·å–æ¨¡å‹æä¾›å•†å®ä¾‹"""
        provider_class = cls.PROVIDERS.get(provider)
        if not provider_class:
            raise ValueError(f"Unsupported provider: {provider}")
        
        if provider == "openai" and api_base:
            return provider_class(api_key, api_base)
        return provider_class(api_key)
    
    @classmethod
    async def chat(
        cls, 
        provider: str,
        api_key: str,
        model: str,
        messages: list,
        stream: bool = False,
        **kwargs
    ):
        """ç»Ÿä¸€çš„èŠå¤©æ¥å£"""
        provider_instance = cls.get_provider(provider, api_key)
        
        if stream:
            return provider_instance.chat_completion_stream(messages, model, **kwargs)
        else:
            return await provider_instance.chat_completion(messages, model, **kwargs)
```

### 6.3 å„å¹³å°é…ç½®ç¤ºä¾‹

```python
# OpenAI é…ç½®
{
    "provider": "openai",
    "model_name": "gpt-4",
    "api_key": "sk-xxx",
    "config": {
        "temperature": 0.7,
        "max_tokens": 2000,
        "top_p": 1.0
    }
}

# é€šä¹‰åƒé—®é…ç½®
{
    "provider": "qwen",
    "model_name": "qwen-max",
    "api_key": "sk-xxx",
    "config": {
        "temperature": 0.8,
        "top_p": 0.8,
        "repetition_penalty": 1.1
    }
}

# DeepSeek é…ç½®
{
    "provider": "deepseek",
    "model_name": "deepseek-chat",
    "api_key": "sk-xxx",
    "config": {
        "temperature": 0.7,
        "max_tokens": 4000
    }
}

# ç¡…åŸºæµåŠ¨é…ç½®
{
    "provider": "siliconflow",
    "model_name": "Qwen/Qwen2-7B-Instruct",
    "api_key": "sk-xxx",
    "config": {
        "temperature": 0.7,
        "max_tokens": 2000,
        "top_p": 0.9
    }
}
```

## ä¸ƒã€æ ¸å¿ƒåŠŸèƒ½å®ç°

### 7.1 ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†

```python
# ç­–ç•¥ï¼š
1. ä½¿ç”¨ Redis ç¼“å­˜æœ€è¿‘çš„ N æ¡æ¶ˆæ¯ï¼ˆå¦‚ 20 æ¡ï¼‰
2. è¶…è¿‡é™åˆ¶æ—¶ï¼Œè‡ªåŠ¨æ‘˜è¦æˆ–è£å‰ªæ—§æ¶ˆæ¯
3. æ”¯æŒæ»‘åŠ¨çª—å£å’Œæ‘˜è¦ç­–ç•¥
4. Token è®¡æ•°æ§åˆ¶ï¼Œé¿å…è¶…å‡ºæ¨¡å‹é™åˆ¶
```

### 7.2 æµå¼å“åº”ï¼ˆSSEï¼‰

```python
# ä½¿ç”¨ FastAPI çš„ StreamingResponse
# æ”¯æŒå®æ—¶æµå¼è¾“å‡º AI å“åº”
# å®¢æˆ·ç«¯ä½¿ç”¨ EventSource æ¥æ”¶
```

### 7.3 å¹¶å‘æ§åˆ¶

```python
# ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”
# åŒä¸€ä¼šè¯åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆæ¯åœ¨å¤„ç†
# é˜²æ­¢ä¸Šä¸‹æ–‡æ··ä¹±
```

### 7.4 åŠ¨æ€æ¨¡å‹é€‰æ‹©ä¸é…ç½®ä¼˜å…ˆçº§

```python
# æ¨¡å‹é…ç½®ä¸‰çº§ä¼˜å…ˆçº§æœºåˆ¶
# 1. è¯·æ±‚çº§åˆ«ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰- å‘é€æ¶ˆæ¯æ—¶æŒ‡å®š
# 2. åº”ç”¨æ¨¡æ¿çº§åˆ«ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰- å¼•ç”¨åº”ç”¨é…ç½®ï¼ˆå¯é€‰ï¼‰
# 3. ç”¨æˆ·é»˜è®¤çº§åˆ«ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰- ç”¨æˆ·çš„é»˜è®¤æ¨¡å‹é…ç½®

# ç¤ºä¾‹å®ç°é€»è¾‘
def get_model_config(request_config, app_config_id, user_id):
    # ä¼˜å…ˆä½¿ç”¨è¯·æ±‚ä¸­ç›´æ¥æŒ‡å®šçš„é…ç½®
    if request_config:
        return request_config
    
    # å…¶æ¬¡ä½¿ç”¨åº”ç”¨æ¨¡æ¿é…ç½®ï¼ˆå¦‚æœæŒ‡å®šï¼‰
    if app_config_id:
        app_config = get_application_config(app_config_id)
        if app_config:
            return app_config.model_config
    
    # æœ€åä½¿ç”¨ç”¨æˆ·é»˜è®¤é…ç½®
    return get_user_default_model_config(user_id)

# æ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢æ¨¡å‹è€Œä¸å½±å“ä¼šè¯
# åŒä¸€ä¼šè¯å†…å¯ä½¿ç”¨å¤šä¸ªä¸åŒçš„æ¨¡å‹
```

### 7.5 é”™è¯¯å¤„ç†ä¸é‡è¯•

```python
# AI è°ƒç”¨å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
# å…¨å±€å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶
# è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
```

## å…«ã€å®‰å…¨è®¾è®¡

### 8.1 è®¤è¯æˆæƒ
- JWT Token è®¤è¯ï¼Œæœ‰æ•ˆæœŸ 7 å¤©
- Refresh Token æœºåˆ¶
- Token é»‘åå•ï¼ˆç”¨æˆ·ç™»å‡ºæ—¶ï¼‰

### 8.2 æ•°æ®å®‰å…¨
- API Key åŠ å¯†å­˜å‚¨ï¼ˆæ”¯æŒå¤šå¹³å°å¯†é’¥ç®¡ç†ï¼‰
- å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†
- HTTPS å¼ºåˆ¶ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- SQL æ³¨å…¥é˜²æŠ¤ï¼ˆä½¿ç”¨ ORMï¼‰

### 8.3 è®¿é—®æ§åˆ¶
- åŸºäºç”¨æˆ· ID çš„èµ„æºéš”ç¦»
- ä¼šè¯å’Œæ¶ˆæ¯çš„æ‰€æœ‰æƒéªŒè¯
- åº”ç”¨é…ç½®çš„æ‰€æœ‰æƒéªŒè¯
- æ¨¡å‹é…ç½®çš„æ‰€æœ‰æƒéªŒè¯
- API é™æµï¼ˆæ¯ç”¨æˆ·æ¯åˆ†é’Ÿé™åˆ¶è¯·æ±‚æ•°ï¼‰

## ä¹ã€æ€§èƒ½ä¼˜åŒ–

### 9.1 æ•°æ®åº“ä¼˜åŒ–
- åˆç†çš„ç´¢å¼•è®¾è®¡
- è¿æ¥æ± é…ç½®ï¼ˆ10-20 è¿æ¥ï¼‰
- æŸ¥è¯¢ä¼˜åŒ–ï¼ˆé¿å… N+1 é—®é¢˜ï¼‰
- åˆ†é¡µæŸ¥è¯¢ï¼ˆé»˜è®¤ 20 æ¡/é¡µï¼‰

### 9.2 ç¼“å­˜ç­–ç•¥
- çƒ­ç‚¹æ•°æ® Redis ç¼“å­˜
- ä¼šè¯ä¸Šä¸‹æ–‡ç¼“å­˜
- åº”ç”¨é…ç½®ç¼“å­˜ï¼ˆ1 å°æ—¶ï¼‰
- ç”¨æˆ·æ¨¡å‹é…ç½®ç¼“å­˜
- å‘é‡æ£€ç´¢ç»“æœç¼“å­˜ï¼ˆMilvusï¼‰

### 9.3 å¼‚æ­¥å¤„ç†
- ä½¿ç”¨ FastAPI çš„å¼‚æ­¥ç‰¹æ€§
- æ•°æ®åº“å¼‚æ­¥é©±åŠ¨ï¼ˆasyncpgï¼‰
- é•¿æ—¶é—´ä»»åŠ¡ä½¿ç”¨ Celery å¼‚æ­¥
- å‘é‡åŒ–ä»»åŠ¡å¼‚æ­¥å¤„ç†

## åã€éƒ¨ç½²æ–¹æ¡ˆ

### 10.1 å¼€å‘ç¯å¢ƒ
```bash
# ä½¿ç”¨ Docker Compose ä¸€é”®å¯åŠ¨
docker-compose up -d
```

### 10.2 ç”Ÿäº§ç¯å¢ƒ
```
- Nginx åå‘ä»£ç†
- Gunicorn + Uvicorn workers
- PostgreSQL ä¸»ä»å¤åˆ¶
- Redis ä¸»ä» + å“¨å…µ
- Milvus é›†ç¾¤éƒ¨ç½²
- Docker + Kubernetesï¼ˆå¯é€‰ï¼‰
```

## åä¸€ã€å¼€å‘è®¡åˆ’

### Phase 1: åŸºç¡€æ¶æ„ï¼ˆ1-2 å‘¨ï¼‰
- [x] é¡¹ç›®åˆå§‹åŒ–
- [ ] æ•°æ®åº“è®¾è®¡ä¸è¿ç§»
- [ ] ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- [ ] åŸºç¡€ API æ¡†æ¶

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ï¼ˆ2-3 å‘¨ï¼‰
- [ ] ç‹¬ç«‹ä¼šè¯ç®¡ç†æ¨¡å—
- [ ] æ¶ˆæ¯å¤„ç†ä¸ AI é›†æˆ
- [ ] æµå¼å“åº”æ”¯æŒ
- [ ] åŠ¨æ€æ¨¡å‹é€‰æ‹©æœºåˆ¶

### Phase 3: å®Œå–„åŠŸèƒ½ï¼ˆ1-2 å‘¨ï¼‰
- [ ] åº”ç”¨é…ç½®æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰
- [ ] æ¨¡å‹é…ç½®ç®¡ç†
- [ ] ä¼šè¯ä¸Šä¸‹æ–‡ä¼˜åŒ–
- [ ] é”™è¯¯å¤„ç†ä¸é‡è¯•
- [ ] API æ–‡æ¡£å®Œå–„

### Phase 4: ä¼˜åŒ–ä¸æµ‹è¯•ï¼ˆ1 å‘¨ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•
- [ ] å®‰å…¨åŠ å›º
- [ ] éƒ¨ç½²æ–‡æ¡£

## åäºŒã€æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

### 12.1 ä¸Šä¸‹æ–‡ç®¡ç†
**éš¾ç‚¹**: é•¿å¯¹è¯çš„ä¸Šä¸‹æ–‡ç»´æŠ¤ï¼ŒToken é™åˆ¶
**æ–¹æ¡ˆ**: 
- å®ç°æ™ºèƒ½æ‘˜è¦ç®—æ³•
- æ»‘åŠ¨çª—å£ + é‡è¦ä¿¡æ¯æå–
- æ”¯æŒæ‰‹åŠ¨å›ºå®šé‡è¦æ¶ˆæ¯

### 12.2 å¹¶å‘å¤„ç†
**éš¾ç‚¹**: åŒä¸€ä¼šè¯çš„å¹¶å‘æ¶ˆæ¯å¤„ç†
**æ–¹æ¡ˆ**:
- Redis åˆ†å¸ƒå¼é”
- æ¶ˆæ¯é˜Ÿåˆ—æ’é˜Ÿå¤„ç†
- WebSocket è¿æ¥çŠ¶æ€ç®¡ç†

### 12.3 æµå¼å“åº”
**éš¾ç‚¹**: SSE è¿æ¥ç®¡ç†ï¼Œé”™è¯¯å¤„ç†
**æ–¹æ¡ˆ**:
- å¿ƒè·³æœºåˆ¶
- è¿æ¥è¶…æ—¶å¤„ç†
- æ–­çº¿é‡è¿æ”¯æŒ

### 12.4 å¤šå¹³å°æ¨¡å‹ç»Ÿä¸€é€‚é…
**éš¾ç‚¹**: å››ä¸ªå¹³å° API ä¸å®Œå…¨å…¼å®¹
**æ–¹æ¡ˆ**:
- ç»Ÿä¸€çš„ Provider æŠ½è±¡åŸºç±»
- é€‚é…å™¨æ¨¡å¼å°è£…ä¸åŒå¹³å°å·®å¼‚
- OpenAI-Compatible åè®®ä¼˜å…ˆï¼ˆDeepSeekã€ç¡…åŸºæµåŠ¨ï¼‰
- é€šä¹‰åƒé—®ä½¿ç”¨å®˜æ–¹ SDKï¼ˆDashScopeï¼‰
- ç»Ÿä¸€çš„å“åº”æ ¼å¼å’Œé”™è¯¯å¤„ç†

### 12.5 ç‹¬ç«‹ä¼šè¯çš„æ¨¡å‹é…ç½®
**éš¾ç‚¹**: ä¼šè¯ä¸ç»‘å®šåº”ç”¨ï¼Œå¦‚ä½•ç®¡ç†æ¨¡å‹é…ç½®
**æ–¹æ¡ˆ**:
- è¯·æ±‚çº§åˆ«æŒ‡å®šæ¨¡å‹å‚æ•°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
- ç”¨æˆ·çº§åˆ«é»˜è®¤æ¨¡å‹é…ç½®
- å¯é€‰å¼•ç”¨åº”ç”¨æ¨¡æ¿é…ç½®
- ä¸‰çº§é…ç½®ä¼˜å…ˆçº§æœºåˆ¶

### 12.6 å¤šå¹³å° API Key ç®¡ç†
**éš¾ç‚¹**: ç”¨æˆ·å¯èƒ½é…ç½®å¤šä¸ªå¹³å°çš„å¯†é’¥
**æ–¹æ¡ˆ**:
- æ”¯æŒæ¯ä¸ªå¹³å°é…ç½®å¤šä¸ªæ¨¡å‹
- API Key åŠ å¯†å­˜å‚¨
- æ”¯æŒè®¾ç½®é»˜è®¤æ¨¡å‹
- è¯·æ±‚æ—¶è‡ªåŠ¨é€‰æ‹©å¯¹åº”å¹³å°çš„ API Key

## åä¸‰ã€æ‰©å±•åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

1. **çŸ¥è¯†åº“é›†æˆï¼ˆåŸºäº Milvusï¼‰**
   - æ–‡æ¡£ä¸Šä¼ ä¸è§£æï¼ˆPDFã€Wordã€TXTã€Markdownï¼‰
   - æ–‡æœ¬åˆ†å—ä¸å‘é‡åŒ–ï¼ˆä½¿ç”¨ Embedding æ¨¡å‹ï¼‰
   - Milvus å‘é‡å­˜å‚¨ä¸æ£€ç´¢
   - RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰é›†æˆ
   - ç›¸ä¼¼åº¦æœç´¢ä¸é‡æ’åº

2. **æ’ä»¶ç³»ç»Ÿ**
   - è‡ªå®šä¹‰å·¥å…·è°ƒç”¨
   - Function Calling
   - Agent æ¨¡å¼

3. **å¤šç§Ÿæˆ·æ”¯æŒ**
   - å›¢é˜Ÿ/ç»„ç»‡ç®¡ç†
   - æƒé™åˆ†çº§
   - èµ„æºé…é¢

4. **ç›‘æ§ä¸åˆ†æ**
   - Token ä½¿ç”¨ç»Ÿè®¡
   - å¯¹è¯è´¨é‡åˆ†æ
   - ç”¨æˆ·è¡Œä¸ºåˆ†æ

---

## é™„å½•

### A. ä¾èµ–åŒ…åˆ—è¡¨ï¼ˆrequirements.txtï¼‰
```
# Web æ¡†æ¶
fastapi==0.104.1
uvicorn[standard]==0.24.0

# æ•°æ®åº“
sqlalchemy==2.0.23
asyncpg==0.29.0
alembic==1.12.1

# æ•°æ®éªŒè¯
pydantic==2.5.0
pydantic-settings==2.1.0

# è®¤è¯å®‰å…¨
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6

# ç¼“å­˜ä¸å¼‚æ­¥ä»»åŠ¡
redis==5.0.1
celery==5.3.4

# AI æ¨¡å‹ SDK
openai==1.3.0                    # OpenAIã€DeepSeekã€ç¡…åŸºæµåŠ¨
dashscope==1.14.0                # é˜¿é‡Œäº‘é€šä¹‰åƒé—®
httpx==0.25.2

# å‘é‡æ•°æ®åº“
pymilvus==2.3.4                  # Milvus Python SDK

# æ–‡æœ¬å¤„ç†ä¸ Embedding
langchain==0.1.0
langchain-community==0.0.10
sentence-transformers==2.2.2     # æœ¬åœ° Embedding æ¨¡å‹

# æ–‡æ¡£è§£æ
pypdf==3.17.0
python-docx==1.1.0
python-pptx==0.6.23
markdown==3.5.1

# å·¥å…·
python-dotenv==1.0.0
loguru==0.7.2
tenacity==8.2.3                  # é‡è¯•æœºåˆ¶
cryptography==41.0.7             # API Key åŠ å¯†
```

### B. ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ.env.exampleï¼‰
```env
# åº”ç”¨é…ç½®
APP_NAME=Medical AI Platform
APP_VERSION=1.0.0
DEBUG=true
SECRET_KEY=your-secret-key-here
ENCRYPTION_KEY=your-encryption-key-for-api-keys

# æ•°æ®åº“
DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/medical_db

# Redis
REDIS_URL=redis://localhost:6379/0

# Milvus å‘é‡æ•°æ®åº“
MILVUS_HOST=localhost
MILVUS_PORT=19530
MILVUS_USER=
MILVUS_PASSWORD=

# JWT
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080

# AI æ¨¡å‹å¹³å°é…ç½®ï¼ˆé»˜è®¤é…ç½®ï¼Œç”¨æˆ·å¯åœ¨ç³»ç»Ÿä¸­è¦†ç›–ï¼‰
# OpenAI
OPENAI_API_KEY=sk-xxx
OPENAI_API_BASE=https://api.openai.com/v1

# é€šä¹‰åƒé—®ï¼ˆé˜¿é‡Œäº‘ DashScopeï¼‰
DASHSCOPE_API_KEY=sk-xxx

# DeepSeek
DEEPSEEK_API_KEY=sk-xxx
DEEPSEEK_API_BASE=https://api.deepseek.com/v1

# ç¡…åŸºæµåŠ¨
SILICONFLOW_API_KEY=sk-xxx
SILICONFLOW_API_BASE=https://api.siliconflow.cn/v1

# Embedding æ¨¡å‹é…ç½®
EMBEDDING_MODEL=BAAI/bge-small-zh-v1.5  # æœ¬åœ°æ¨¡å‹
# EMBEDDING_PROVIDER=openai              # æˆ–ä½¿ç”¨ OpenAI çš„ Embedding

# å…¶ä»–
CORS_ORIGINS=["http://localhost:3000"]
MAX_UPLOAD_SIZE=10485760  # 10MB
RATE_LIMIT_PER_MINUTE=60
```

### C. Docker Compose é…ç½®ç¤ºä¾‹

```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    container_name: medical_postgres
    environment:
      POSTGRES_DB: medical_db
      POSTGRES_USER: medical_user
      POSTGRES_PASSWORD: medical_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

  # Redis ç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: medical_redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped

  # Milvus Etcd (Milvus ä¾èµ–)
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    container_name: milvus_etcd
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - etcd_data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd

  # Milvus MinIO (å¯¹è±¡å­˜å‚¨)
  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    container_name: milvus_minio
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/minio_data
    command: minio server /minio_data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"

  # Milvus Standalone
  milvus:
    image: milvusdb/milvus:v2.3.3
    container_name: medical_milvus
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    depends_on:
      - etcd
      - minio
    restart: unless-stopped

  # FastAPI åº”ç”¨
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: medical_api
    environment:
      - DATABASE_URL=postgresql+asyncpg://medical_user:medical_pass@postgres:5432/medical_db
      - REDIS_URL=redis://redis:6379/0
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
    volumes:
      - ./app:/app/app
      - ./uploads:/app/uploads
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - redis
      - milvus
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  etcd_data:
  minio_data:
  milvus_data:
```

### D. æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨å‚è€ƒ

#### OpenAI
- gpt-4-turbo
- gpt-4
- gpt-3.5-turbo
- gpt-3.5-turbo-16k

#### é€šä¹‰åƒé—®ï¼ˆé˜¿é‡Œäº‘ï¼‰
- qwen-max (æœ€å¼º)
- qwen-plus (å¢å¼º)
- qwen-turbo (æ ‡å‡†)
- qwen-vl-plus (è§†è§‰)
- qwen-long (é•¿æ–‡æœ¬)

#### DeepSeek
- deepseek-chat (å¯¹è¯)
- deepseek-coder (ä»£ç )

#### ç¡…åŸºæµåŠ¨ï¼ˆéƒ¨åˆ†å¼€æºæ¨¡å‹ï¼‰
- Qwen/Qwen2-7B-Instruct
- Qwen/Qwen2-72B-Instruct
- THUDM/chatglm3-6b
- deepseek-ai/DeepSeek-V2-Chat
- meta-llama/Meta-Llama-3-8B-Instruct

---

**æ³¨æ„**: æ­¤æ–¹æ¡ˆä¸ºåˆæ­¥è®¾è®¡ï¼Œå…·ä½“å®ç°æ—¶å¯æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ã€‚

